#!/usr/bin/env python3
import argparse
import socket
from enum import Enum
from urllib.request import urlopen

LONGEST_POSSIBLE_IP_ADDRESS_STRING = 99


class DesiredResults(Enum):
    LOCAL = 1
    GLOBAL = 2
    BOTH = 4


def parse_args():
    parser = argparse.ArgumentParser(description="get your IP address")
    parser.add_argument(
        "desired",
        nargs="?",  # Changed to "?" for optional single argument
        choices=["local", "l", "global", "g", "gl", "lg"],
        default=None,  # Set default to None
        help="what kind of IP do you want? (default: both)",
    )
    args = parser.parse_args()

    # Default to BOTH if no arguments provided
    if args.desired is None:
        return DesiredResults.BOTH

    desired = args.desired
    wants_both_shorthand = desired in ["gl", "lg"]
    wants_local = wants_both_shorthand or desired in ["local", "l"]
    wants_global = wants_both_shorthand or desired in ["global", "g"]

    if wants_local and wants_global:
        return DesiredResults.BOTH
    if wants_local:
        return DesiredResults.LOCAL
    if wants_global:
        return DesiredResults.GLOBAL
    raise Exception("internal error parsing args")


def local_ip():
    return socket.gethostbyname(socket.gethostname())


def global_ip():
    with urlopen("https://icanhazip.com/", timeout=30) as response:
        if response.status != 200:
            return f"{response.status} error from upstream"
        return response.read(LONGEST_POSSIBLE_IP_ADDRESS_STRING).decode("utf-8").strip()


def main():
    desired_results = parse_args()

    if desired_results == DesiredResults.LOCAL:
        print(local_ip())
    elif desired_results == DesiredResults.GLOBAL:
        print(global_ip())
    else:  # BOTH or default
        print("local:", local_ip())
        print("global:", global_ip())


if __name__ == "__main__":
    main()
